<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <!-- Enhanced viewport for mobile -->
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes"
    />

    <!-- Mobile Web App capabilities -->
    <meta name="mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="default" />
    <meta name="apple-mobile-web-app-title" content="ShiftPay" />

    <!-- Prevent format detection -->
    <meta name="format-detection" content="telephone=no" />
    <meta name="format-detection" content="email=no" />

    <!-- Theme colors for mobile browsers -->
    <meta name="theme-color" content="#667eea" />
    <meta name="msapplication-navbutton-color" content="#667eea" />
    <meta
      name="apple-mobile-web-app-status-bar-style"
      content="black-translucent"
    />

    <!-- PWA Manifest -->
    <link rel="manifest" href="manifest.json" />
    
    <!-- App icons for mobile and desktop -->
    <link
      rel="icon"
      type="image/svg+xml"
      href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 32 32'><defs><linearGradient id='bgIcon' x1='0%' y1='0%' x2='100%' y2='100%'><stop offset='0%' stop-color='%23667eea'/><stop offset='100%' stop-color='%23764ba2'/></linearGradient></defs><rect width='32' height='32' fill='url(%23bgIcon)' rx='6'/><g transform='translate(16,16)'><circle cx='0' cy='-6' r='1.5' fill='white'/><rect x='-8' y='-2' width='5' height='8' rx='1' fill='white'/><rect x='3' y='-2' width='5' height='8' rx='1' fill='white'/><rect x='-6' y='0' width='2' height='3' rx='0.5' fill='%234facfe'/><rect x='4' y='0' width='2' height='3' rx='0.5' fill='%234facfe'/><rect x='-4' y='8' width='8' height='1' rx='0.5' fill='%23ffc107'/></g></svg>"
    />
    <link
      rel="apple-touch-icon"
      sizes="180x180"
      href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 180 180'><defs><linearGradient id='bgApple' x1='0%' y1='0%' x2='100%' y2='100%'><stop offset='0%' stop-color='%23667eea'/><stop offset='100%' stop-color='%23764ba2'/></linearGradient></defs><rect width='180' height='180' fill='url(%23bgApple)' rx='40'/><g transform='translate(90,90)'><circle cx='0' cy='-25' r='8' fill='white'/><rect x='-40' y='-12' width='25' height='40' rx='4' fill='white'/><rect x='15' y='-12' width='25' height='40' rx='4' fill='white'/><rect x='-33' y='-5' width='12' height='18' rx='2' fill='%234facfe'/><rect x='21' y='-5' width='12' height='18' rx='2' fill='%234facfe'/><rect x='-25' y='32' width='50' height='5' rx='2' fill='%23ffc107'/></g></svg>"
    />
    <link
      rel="apple-touch-icon"
      sizes="152x152"
      href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 152 152'><defs><linearGradient id='bg152' x1='0%' y1='0%' x2='100%' y2='100%'><stop offset='0%' stop-color='%23667eea'/><stop offset='100%' stop-color='%23764ba2'/></linearGradient></defs><rect width='152' height='152' fill='url(%23bg152)' rx='34'/><g transform='translate(76,76)'><circle cx='0' cy='-22' r='7' fill='white'/><rect x='-35' y='-10' width='22' height='35' rx='3' fill='white'/><rect x='13' y='-10' width='22' height='35' rx='3' fill='white'/><rect x='-29' y='-4' width='11' height='16' rx='2' fill='%234facfe'/><rect x='18' y='-4' width='11' height='16' rx='2' fill='%234facfe'/><rect x='-22' y='28' width='44' height='4' rx='2' fill='%23ffc107'/></g></svg>"
    />
    <link
      rel="apple-touch-icon"
      sizes="120x120"
      href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 120 120'><defs><linearGradient id='bg120' x1='0%' y1='0%' x2='100%' y2='100%'><stop offset='0%' stop-color='%23667eea'/><stop offset='100%' stop-color='%23764ba2'/></linearGradient></defs><rect width='120' height='120' fill='url(%23bg120)' rx='26'/><g transform='translate(60,60)'><circle cx='0' cy='-18' r='5' fill='white'/><rect x='-28' y='-8' width='18' height='28' rx='3' fill='white'/><rect x='10' y='-8' width='18' height='28' rx='3' fill='white'/><rect x='-23' y='-3' width='8' height='12' rx='1' fill='%234facfe'/><rect x='15' y='-3' width='8' height='12' rx='1' fill='%234facfe'/><rect x='-18' y='23' width='36' height='3' rx='1' fill='%23ffc107'/></g></svg>"
    />
    <link
      rel="apple-touch-icon"
      sizes="76x76"
      href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 76 76'><defs><linearGradient id='bg76' x1='0%' y1='0%' x2='100%' y2='100%'><stop offset='0%' stop-color='%23667eea'/><stop offset='100%' stop-color='%23764ba2'/></linearGradient></defs><rect width='76' height='76' fill='url(%23bg76)' rx='17'/><g transform='translate(38,38)'><circle cx='0' cy='-12' r='3' fill='white'/><rect x='-18' y='-5' width='11' height='18' rx='2' fill='white'/><rect x='7' y='-5' width='11' height='18' rx='2' fill='white'/><rect x='-15' y='-2' width='5' height='8' rx='1' fill='%234facfe'/><rect x='10' y='-2' width='5' height='8' rx='1' fill='%234facfe'/><rect x='-11' y='15' width='22' height='2' rx='1' fill='%23ffc107'/></g></svg>"
    />

    <!-- Preload critical resources -->
    <link
      rel="preload"
      href="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"
      as="script"
    />

    <title>Shift Pay Calculator Dashboard</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <link rel="stylesheet" href="assets/css/main.css" />
    <link rel="stylesheet" href="assets/css/animations.css" />

    <!-- Critical CSS for mobile loading -->
    <style>
      /* Critical mobile loading styles */
      body {
        margin: 0;
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", system-ui,
          sans-serif;
        -webkit-text-size-adjust: 100%;
        -webkit-tap-highlight-color: transparent;
      }

      .loading-spinner {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        z-index: 9999;
        display: none;
      }

      /* Smooth scrolling for mobile */
      * {
        -webkit-overflow-scrolling: touch;
      }

      /* Touch improvements */
      button,
      .nav-item,
      .stat-card {
        -webkit-tap-highlight-color: rgba(0, 0, 0, 0.1);
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }
    </style>
  </head>

  <body>
    <!-- Loading spinner for mobile -->
    <div class="loading-spinner" id="loadingSpinner">
      <div
        style="
          width: 40px;
          height: 40px;
          border: 3px solid #f3f3f3;
          border-top: 3px solid #667eea;
          border-radius: 50%;
          animation: spin 1s linear infinite;
        "
      ></div>
    </div>

    <!-- Modern Notification Container -->
    <div class="notification-container" id="notificationContainer"></div>

    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
      <div class="loading-content">
        <div class="loading-spinner"></div>
        <div class="loading-text" id="loadingText">Processing...</div>
      </div>
    </div>

    <!-- Mobile menu toggle will be inserted here by JavaScript -->

    <div class="app-container">
      <!-- Sidebar Navigation -->
      <nav class="sidebar">
        <div class="sidebar-header">
          <h2>🏭 ShiftPay</h2>
          <p>Dashboard</p>
        </div>
        <!-- Replace your existing nav-menu in index.html with this updated version -->
        <ul class="nav-menu">
          <li class="nav-item active" data-page="dashboard">
            <span class="nav-icon">📊</span>
            Dashboard
          </li>
          <li class="nav-item" data-page="calculator">
            <span class="nav-icon">💰</span>
            Calculator
          </li>
          <li class="nav-item" data-page="weekly">
            <span class="nav-icon">📅</span>
            Weekly Report
          </li>
          <!-- NEW: Calendar View Link -->
          <li
            class="nav-item external-link"
            onclick="window.location.href='pages/calendar.html'"
          >
            <span class="nav-icon">🗓️</span>
            Calendar View
          </li>
          <!-- NEW: Tax Calculator Link -->
          <li
            class="nav-item external-link"
            onclick="window.location.href='pages/tax-calculator.html'"
          >
            <span class="nav-icon">🧮</span>
            Tax Calculator
          </li>
          <li class="nav-item" data-page="shifts">
            <span class="nav-icon">⏰</span>
            Shift Schedule
          </li>
          <li class="nav-item" data-page="settings">
            <span class="nav-icon">⚙️</span>
            Settings
          </li>
        </ul>
      </nav>

      <!-- Main Content -->
      <main class="main-content">
        <!-- Dashboard Page -->
        <div id="dashboard" class="page active">
          <div class="page-header">
            <div>
              <h1>Dashboard Overview</h1>
              <p>Welcome to your shift management system</p>
            </div>
          </div>

          <div class="dashboard-grid">
            <div class="stat-card">
              <div class="stat-icon">💰</div>
              <div class="stat-content">
                <h3 id="totalEarnings">¥0</h3>
                <p>Total Earnings</p>
              </div>
            </div>
            <div class="stat-card">
              <div class="stat-icon">⏱️</div>
              <div class="stat-content">
                <h3 id="totalHours">0h</h3>
                <p>Total Hours</p>
              </div>
            </div>
            <div class="stat-card">
              <div class="stat-icon">📊</div>
              <div class="stat-content">
                <h3 id="averageDaily">¥0</h3>
                <p>Daily Average</p>
              </div>
            </div>
            <div class="stat-card">
              <div class="stat-icon">🎯</div>
              <div class="stat-content">
                <h3 id="weeklyGoal">75%</h3>
                <p>Weekly Goal</p>
              </div>
            </div>
          </div>

          <div class="dashboard-charts">
            <div class="chart-container">
              <h3>Weekly Earnings Trend</h3>
              <canvas id="dashboardChart"></canvas>
            </div>
            <div class="recent-shifts">
              <h3>Recent Shifts</h3>
              <div id="recentShiftsList" class="shifts-list"></div>
            </div>
          </div>

          <!-- NEW: Advanced Charts Section -->
          <div class="advanced-charts-section">
            <div class="charts-grid">
              <!-- Monthly Comparison Chart -->
              <div class="chart-card">
                <h3>📈 Monthly Earnings Comparison</h3>
                <div class="chart-container">
                  <canvas id="monthlyComparisonChart"></canvas>
                </div>
                <div class="stats-row">
                  <div class="stat-item">
                    <div class="stat-value" id="currentMonthTotal">¥0</div>
                    <div class="stat-label">Current Month</div>
                  </div>
                  <div class="stat-item">
                    <div class="stat-value" id="previousMonthTotal">¥0</div>
                    <div class="stat-label">Previous Month</div>
                  </div>
                  <div class="stat-item">
                    <div class="stat-value growth-rate" id="growthRate">0%</div>
                    <div class="stat-label">Growth Rate</div>
                  </div>
                </div>
              </div>

              <!-- Shift Pattern Heatmap -->
              <div class="chart-card">
                <h3>🗓️ Weekly Work Pattern</h3>
                <div class="chart-container heatmap-container">
                  <canvas id="shiftHeatmapChart"></canvas>
                </div>
                <div class="stats-row">
                  <div class="stat-item">
                    <div class="stat-value" id="peakHour">-</div>
                    <div class="stat-label">Peak Hour</div>
                  </div>
                  <div class="stat-item">
                    <div class="stat-value" id="mostActiveDay">-</div>
                    <div class="stat-label">Most Active Day</div>
                  </div>
                  <div class="stat-item">
                    <div class="stat-value" id="totalShifts">0</div>
                    <div class="stat-label">Total Shifts</div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Calculator Page -->
        <div id="calculator" class="page">
          <div class="page-header">
            <div>
              <h1>Pay Calculator</h1>
              <p>Calculate your shift earnings</p>
            </div>
          </div>

          <div class="calculator-container">
            <div class="form-section">
              <div class="form-group">
                <label for="shiftType" class="required">Shift Type</label>
                <select id="shiftType" onchange="updateShiftInfo()" required>
                  <option value="">Select Shift Type</option>
                  <option value="C341">C341 - Day Shift (06:30〜17:30)</option>
                  <option value="C342">
                    C342 - Night Shift (16:45〜01:25)
                  </option>
                </select>
                <div class="form-error" id="shiftTypeError"></div>
              </div>

              <div class="form-row">
                <div class="form-group">
                  <label for="startTime" class="required">Start Time</label>
                  <input type="time" id="startTime" required />
                  <div class="form-error" id="startTimeError"></div>
                </div>
                <div class="form-group">
                  <label for="endTime" class="required">End Time</label>
                  <input type="time" id="endTime" required />
                  <div class="form-error" id="endTimeError"></div>
                </div>
              </div>

              <div class="form-group">
                <label for="workDate" class="required">Work Date</label>
                <input type="date" id="workDate" required />
                <div class="form-error" id="workDateError"></div>
              </div>

              <button
                class="calculate-btn btn-primary btn-lg"
                onclick="calculatePay()"
                id="calculateButton"
              >
                <span>💰</span> Calculate Pay
              </button>
            </div>

            <div id="shiftInfo" class="shift-info" style="display: none">
              <h4>📋 Break Schedule</h4>
              <div id="breakList" class="break-list"></div>
            </div>

            <div id="results" class="results-section" style="display: none">
              <div class="result-card">
                <h3>💰 Pay Breakdown</h3>
                <div id="paySummary" class="pay-summary"></div>
              </div>

              <div class="charts-row">
                <div class="chart-wrapper">
                  <h4>Working Time</h4>
                  <canvas id="pieChart"></canvas>
                </div>
                <div class="chart-wrapper">
                  <h4>Pay Distribution</h4>
                  <canvas id="barChart"></canvas>
                </div>
              </div>

              <button class="add-btn" onclick="addToWeekly()">
                <span>➕</span> Add to Weekly Report
              </button>
            </div>
          </div>
        </div>

        <!-- Weekly Report Page -->
        <div id="weekly" class="page">
          <div class="page-header">
            <div>
              <h1>Weekly Report</h1>
              <p>Track your weekly performance</p>
            </div>
            <button class="clear-btn" onclick="clearWeekly()">Clear All</button>
          </div>

          <div id="weeklySummaryCards" class="weekly-summary"></div>

          <div class="weekly-content">
            <div class="weekly-list">
              <h3>Work Entries</h3>
              <div id="weeklyEntries" class="entries-list"></div>
            </div>
            <div class="weekly-chart">
              <h3>Weekly Performance</h3>
              <canvas id="weeklyChart"></canvas>
            </div>
          </div>
        </div>

        <!-- Shift Schedule Page -->
        <div id="shifts" class="page">
          <div class="page-header">
            <div>
              <h1>Shift Schedules</h1>
              <p>View all available shift types and break schedules</p>
            </div>
          </div>

          <div class="shifts-grid">
            <div class="shift-card">
              <div class="shift-header">
                <h3>C341 - Day Shift</h3>
                <span class="shift-time">06:30 〜 17:30</span>
              </div>
              <div class="shift-details">
                <p><strong>Total Duration:</strong> 11 hours</p>
                <p><strong>Net Working:</strong> 9h 20m</p>
                <p><strong>Break Time:</strong> 1h 40m</p>
              </div>
              <div class="break-schedule">
                <h4>Break Schedule:</h4>
                <div class="breaks-grid">
                  <div class="break-item">08:30〜08:40 <span>10m</span></div>
                  <div class="break-item">10:40〜11:25 <span>45m</span></div>
                  <div class="break-item">13:05〜13:15 <span>10m</span></div>
                  <div class="break-item">14:35〜14:45 <span>10m</span></div>
                  <div class="break-item">16:10〜16:20 <span>10m</span></div>
                  <div class="break-item">17:20〜17:35 <span>15m</span></div>
                </div>
              </div>
            </div>

            <div class="shift-card">
              <div class="shift-header">
                <h3>C342 - Night Shift</h3>
                <span class="shift-time">16:45 〜 01:25</span>
              </div>
              <div class="shift-details">
                <p><strong>Total Duration:</strong> 8h 40m</p>
                <p><strong>Net Working:</strong> 7h</p>
                <p><strong>Break Time:</strong> 1h 40m</p>
              </div>
              <div class="break-schedule">
                <h4>Break Schedule:</h4>
                <div class="breaks-grid">
                  <div class="break-item">18:45〜18:55 <span>10m</span></div>
                  <div class="break-item">20:55〜21:40 <span>45m</span></div>
                  <div class="break-item">23:10〜23:20 <span>10m</span></div>
                  <div class="break-item">00:50〜01:00 <span>10m</span></div>
                  <div class="break-item">02:25〜02:35 <span>10m</span></div>
                  <div class="break-item">03:35〜03:50 <span>15m</span></div>
                </div>
              </div>
            </div>
          </div>

          <div class="pay-rates-card">
            <h3>💰 Pay Rate Information</h3>
            <div class="rates-grid">
              <div class="rate-item">
                <h4>⏰ Regular Hours</h4>
                <p>First 7h 35m: <strong>¥2,100/hour</strong></p>
              </div>
              <div class="rate-item">
                <h4>⚡ Overtime</h4>
                <p>After 7h 35m: <strong>¥2,625/hour</strong></p>
              </div>
              <div class="rate-item">
                <h4>🌙 Night Premium</h4>
                <p>After 22:00: <strong>¥2,625/hour</strong></p>
              </div>
            </div>
          </div>
        </div>

        <!-- Settings Page -->
        <div id="settings" class="page">
          <div class="page-header">
            <div>
              <h1>Settings</h1>
              <p>Customize your application preferences</p>
            </div>
          </div>

          <div class="settings-container">
            <div class="setting-group">
              <h3>💰 Pay Rates</h3>
              <div class="setting-item">
                <label for="baseRate">Base Hourly Rate (¥)</label>
                <input
                  type="number"
                  id="baseRate"
                  value="2100"
                  min="1000"
                  max="5000"
                />
              </div>
              <div class="setting-item">
                <label for="overtimeRate">Overtime/Night Rate (¥)</label>
                <input
                  type="number"
                  id="overtimeRate"
                  value="2625"
                  min="1000"
                  max="10000"
                />
              </div>
            </div>

            <div class="setting-group">
              <h3>🎯 Goals</h3>
              <div class="setting-item">
                <label for="weeklyGoalHours">Weekly Goal (Hours)</label>
                <input
                  type="number"
                  id="weeklyGoalHours"
                  value="40"
                  min="1"
                  max="80"
                />
              </div>
              <div class="setting-item">
                <label for="weeklyGoalPay">Weekly Goal (¥)</label>
                <input
                  type="number"
                  id="weeklyGoalPay"
                  value="100000"
                  min="10000"
                  max="500000"
                />
              </div>
            </div>

            <div class="setting-group">
              <h3>📊 Data Management</h3>
              <div
                style="
                  display: grid;
                  grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
                  gap: 15px;
                "
              >
                <button class="export-btn" onclick="exportData()">
                  📊 Export CSV
                </button>
                <button class="export-btn" onclick="exportSummaryData()">
                  📈 Export Summary
                </button>
                <button class="import-btn" onclick="importCSV()">
                  📥 Import CSV
                </button>
                <button class="export-btn" onclick="exportJSON()">
                  💾 Export JSON
                </button>
                <button class="import-btn" onclick="importJSON()">
                  📁 Import JSON
                </button>
              </div>
              
              <!-- Hidden file input for JSON import -->
              <input type="file" id="importFile" accept=".json" style="display: none;" />
              
              <p style="margin-top: 15px; color: #666; font-size: 0.9rem">
                💡 CSV format is compatible with Excel and Google Sheets<br />
                JSON format preserves all data for backup/restore
              </p>
            </div>
          </div>
        </div>
      </main>
    </div>

    <!-- Enhanced script loading for mobile -->
    <script>
      // Show loading spinner on mobile
      if (window.innerWidth <= 768) {
        document.getElementById("loadingSpinner").style.display = "block";
      }

      // Hide loading spinner when everything is loaded
      window.addEventListener("load", function () {
        document.getElementById("loadingSpinner").style.display = "none";
      });

      // Prevent zoom on double tap (iOS)
      let lastTouchEnd = 0;
      document.addEventListener(
        "touchend",
        function (event) {
          const now = new Date().getTime();
          if (now - lastTouchEnd <= 300) {
            event.preventDefault();
          }
          lastTouchEnd = now;
        },
        false
      );

      // Add touch class to body if touch device
      if ("ontouchstart" in window || navigator.maxTouchPoints > 0) {
        document.body.classList.add("touch-device");
      }
      
      // iOS Safari Navigation Fix - Prevent duplicate navigation
      function ensureSingleNavigation() {
        const isMobile = window.innerWidth <= 768;
        const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
        
        if (isMobile) {
          // Hide any duplicate navigation elements
          const duplicateNavs = document.querySelectorAll('nav:not(.sidebar), .main-content nav, .main-content .nav-menu');
          duplicateNavs.forEach(nav => {
            if (!nav.classList.contains('sidebar')) {
              nav.style.display = 'none';
            }
          });
          
          // Ensure mobile toggle is visible on mobile only
          const mobileToggle = document.querySelector('.mobile-menu-toggle');
          if (mobileToggle) {
            mobileToggle.style.display = 'flex';
          }
          
          // Ensure sidebar is hidden by default on mobile
          const sidebar = document.querySelector('.sidebar');
          if (sidebar && !sidebar.classList.contains('mobile-open')) {
            sidebar.style.transform = 'translateX(-100%)';
          }
        } else {
          // Desktop: hide mobile toggle, show sidebar
          const mobileToggle = document.querySelector('.mobile-menu-toggle');
          if (mobileToggle) {
            mobileToggle.style.display = 'none';
          }
          
          const sidebar = document.querySelector('.sidebar');
          if (sidebar) {
            sidebar.style.transform = 'translateX(0)';
            sidebar.classList.remove('mobile-open');
          }
        }
      }
      
      // Run on load and resize
      ensureSingleNavigation();
      window.addEventListener('resize', ensureSingleNavigation);
      window.addEventListener('orientationchange', () => {
        setTimeout(ensureSingleNavigation, 100);
      });
      
      // iOS Touch Fix - Reset body interactions periodically
      function resetBodyInteractions() {
        document.body.style.overflow = '';
        document.body.style.touchAction = '';
        document.body.style.pointerEvents = '';
        document.body.style.userSelect = '';
        document.body.style.webkitUserSelect = '';
        
        // Remove any lingering overlays
        const overlay = document.querySelector('.mobile-overlay');
        if (overlay && !overlay.classList.contains('active')) {
          overlay.style.display = 'none';
          overlay.style.pointerEvents = 'none';
        }
      }
      
      // Reset interactions on any touch/click
      document.addEventListener('touchstart', resetBodyInteractions, { passive: true });
      document.addEventListener('click', resetBodyInteractions, { passive: true });
      
      // Periodic reset for iOS (every 2 seconds)
      if (/iPad|iPhone|iPod/.test(navigator.userAgent)) {
        setInterval(resetBodyInteractions, 2000);
      }
    </script>

    <!-- Load external scripts -->
    <script src="assets/js/modules/break_schedule.js"></script>
    <script src="assets/js/core/ui-enhancements.js"></script>
    <script src="assets/js/core/main.js"></script>
    <script src="assets/js/core/chart.js"></script>

    <!-- Force navigation binding -->
    <script>
      // Backup navigation function
      function forceNavigationSetup() {
        console.log("Setting up backup navigation...");
        const navItems = document.querySelectorAll(".nav-item");
        const pages = document.querySelectorAll(".page");

        navItems.forEach((item, index) => {
          // Skip items that have onclick handlers (external links)
          if (item.hasAttribute("onclick")) {
            console.log(
              "Skipping external navigation item:",
              item.textContent.trim()
            );
            return;
          }

          const targetPage = item.getAttribute("data-page");
          if (!targetPage) {
            console.log(
              "Skipping nav item without data-page:",
              item.textContent.trim()
            );
            return;
          }

          // Remove existing listeners without cloning (preserve onclick handlers)
          item.removeEventListener("click", item._navHandler);

          // Create new handler
          const navHandler = function (e) {
            e.preventDefault();
            e.stopPropagation();

            console.log("Force navigation to:", targetPage);

            // Update active nav item
            document
              .querySelectorAll(".nav-item")
              .forEach((nav) => nav.classList.remove("active"));
            item.classList.add("active");

            // Show target page
            document
              .querySelectorAll(".page")
              .forEach((page) => page.classList.remove("active"));
            const targetPageElement = document.getElementById(targetPage);
            if (targetPageElement) {
              targetPageElement.classList.add("active");
            }

            // Update page content
            if (
              targetPage === "dashboard" &&
              typeof updateDashboard === "function"
            ) {
              updateDashboard();
            } else if (
              targetPage === "weekly" &&
              typeof updateWeeklyDisplay === "function"
            ) {
              updateWeeklyDisplay();
              if (typeof updateWeeklyChart === "function") {
                updateWeeklyChart();
              }
            }

            // Close mobile menu if on mobile
            if (window.innerWidth <= 768) {
              const sidebar = document.querySelector('.sidebar');
              const overlay = document.querySelector('.mobile-overlay');
              const toggle = document.querySelector('.mobile-menu-toggle');
              
              if (sidebar) {
                sidebar.classList.remove('mobile-open');
              }
              if (overlay) {
                overlay.classList.remove('active');
              }
              if (toggle) {
                toggle.innerHTML = "☰";
              }
              
              // Restore body interactions
              document.body.style.overflow = '';
              document.body.style.touchAction = '';
              document.body.style.pointerEvents = '';
            }
          };

          // Store handler reference and add listener
          item._navHandler = navHandler;
          item.addEventListener("click", navHandler);
        });
      }

      // Enhanced navigation setup with mobile support
      setTimeout(() => {
        const navItems = document.querySelectorAll(".nav-item[data-page]");
        let hasWorkingNav = false;

        navItems.forEach((item) => {
          if (item._navHandler) {
            hasWorkingNav = true;
          }
        });

        if (!hasWorkingNav) {
          console.log("Main navigation not working, setting up backup...");
          forceNavigationSetup();
        } else {
          console.log("Main navigation is working properly");
        }
        
        // Add mobile touch improvements
        enhanceMobileNavigation();
      }, 500); // Reduced timeout for faster initialization
      
      // Simple mobile navigation enhancement function
      function enhanceMobileNavigation() {
        const navItems = document.querySelectorAll('.nav-item');
        
        navItems.forEach(item => {
          // Only add touch styling, don't interfere with click handlers
          item.style.touchAction = 'manipulation';
          item.style.webkitTapHighlightColor = 'rgba(102, 126, 234, 0.1)';
          
          // Add visual feedback for touch
          item.addEventListener('touchstart', function(e) {
            this.classList.add('nav-item-pressed');
          }, { passive: true });
          
          item.addEventListener('touchend', function(e) {
            this.classList.remove('nav-item-pressed');
          }, { passive: true });
          
          item.addEventListener('touchcancel', function(e) {
            this.classList.remove('nav-item-pressed');
          }, { passive: true });
        });
        
        console.log('Mobile navigation enhancements applied');
      }
    </script>

    <script>
      // Override displayResults function to integrate with charts
      function displayResults(calc) {
        const resultsSection = document.getElementById("results");
        const paySummary = document.getElementById("paySummary");

        let summaryHTML = `
                <div class="pay-item">
                    <div class="label">Total Hours</div>
                    <div class="value">${(
                      calc.workingTime.totalMinutes / 60
                    ).toFixed(2)}h</div>
                </div>
                <div class="pay-item">
                    <div class="label">Break Time</div>
                    <div class="value">${(
                      calc.workingTime.breakMinutes / 60
                    ).toFixed(2)}h</div>
                </div>
                <div class="pay-item">
                    <div class="label">Net Working</div>
                    <div class="value">${calc.workingTime.netHours.toFixed(
                      2
                    )}h</div>
                </div>
                <div class="pay-item">
                    <div class="label">Regular Pay</div>
                    <div class="value">¥${Math.round(
                      calc.payInfo.regularPay
                    )}</div>
                </div>
            `;

        if (calc.payInfo.overtimeHours > 0) {
          summaryHTML += `
                    <div class="pay-item">
                        <div class="label">Overtime Pay</div>
                        <div class="value">¥${Math.round(
                          calc.payInfo.overtimePay
                        )}</div>
                    </div>
                `;
        }

        if (calc.payInfo.hasNightHours) {
          summaryHTML += `
                    <div class="pay-item">
                        <div class="label">Night Premium</div>
                        <div class="value">¥${Math.round(
                          calc.payInfo.nightPay
                        )}</div>
                    </div>
                `;
        }

        summaryHTML += `
                <div class="pay-item">
                    <div class="label">Total Pay</div>
                    <div class="value">¥${Math.round(
                      calc.payInfo.totalPay
                    )}</div>
                </div>
            `;

        paySummary.innerHTML = summaryHTML;
        resultsSection.style.display = "block";

        // Create charts for the calculation
        if (typeof createCalculatorCharts === "function") {
          createCalculatorCharts(calc);
        }

        // Scroll to results
        resultsSection.scrollIntoView({ behavior: "smooth" });
      }

      // Initialize app when DOM is loaded
      document.addEventListener("DOMContentLoaded", function () {
        console.log("DOM loaded, initializing app...");

        // Check if all required scripts are loaded
        if (typeof SHIFTS === "undefined") {
          console.error("break_schedule.js not loaded - SHIFTS undefined");
          alert(
            "Error: Break schedule data not loaded. Please refresh the page."
          );
          return;
        }

        if (typeof updateDashboard === "undefined") {
          console.error("script.js not loaded - updateDashboard undefined");
          alert("Error: Main script not loaded. Please refresh the page.");
          return;
        }

        // Check for chart functions with better debugging
        const chartFunctionsCheck = {
          createCalculatorCharts: typeof createCalculatorCharts,
          updateDashboardChart: typeof updateDashboardChart,
          Chart: typeof Chart,
        };

        console.log("Chart functions check:", chartFunctionsCheck);

        if (typeof createCalculatorCharts === "undefined") {
          console.error(
            "chart.js not loaded - createCalculatorCharts undefined"
          );
          console.error(
            "Available functions:",
            Object.getOwnPropertyNames(window).filter(
              (name) => name.includes("chart") || name.includes("Chart")
            )
          );

          // Try to load chart functions manually
          if (typeof window.createCalculatorCharts !== "undefined") {
            console.log("Found createCalculatorCharts in window object");
            window.createCalculatorCharts = window.createCalculatorCharts;
          } else {
            alert(
              "Error: Chart functions not loaded. Please refresh the page."
            );
            return;
          }
        }

        console.log("All scripts loaded successfully");

        // Initialize navigation and dashboard
        try {
          if (typeof initializeNavigation === "function") {
            initializeNavigation();
            console.log("Navigation initialized");
          }

          if (typeof updateDashboard === "function") {
            updateDashboard();
            console.log("Dashboard updated");
          }

          if (typeof updateWeeklyDisplay === "function") {
            updateWeeklyDisplay();
            console.log("Weekly display updated");
          }

          if (typeof loadSettings === "function") {
            loadSettings();
            console.log("Settings loaded");
          }

          if (typeof setTodayDate === "function") {
            setTodayDate();
            console.log("Today date set");
          }

          // Initialize mobile features if available
          if (typeof initializeMobileFeatures === "function") {
            initializeMobileFeatures();
            console.log("Mobile features initialized");
          }

          console.log("App initialization complete!");
        } catch (error) {
          console.error("Error during initialization:", error);
          alert("Error initializing app: " + error.message);
        }
      });
    </script>
    
    <!-- Service Worker Registration -->
    <script>
      // Register service worker for PWA functionality
      if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
          navigator.serviceWorker.register('/sw.js')
            .then((registration) => {
              console.log('SW registered: ', registration);
              
              // Check for updates
              registration.addEventListener('updatefound', () => {
                const newWorker = registration.installing;
                newWorker.addEventListener('statechange', () => {
                  if (newWorker.state === 'installed') {
                    if (navigator.serviceWorker.controller) {
                      // New version available
                      if (confirm('New version available! Reload to update?')) {
                        newWorker.postMessage({ type: 'SKIP_WAITING' });
                        window.location.reload();
                      }
                    }
                  }
                });
              });
            })
            .catch((registrationError) => {
              console.log('SW registration failed: ', registrationError);
            });
        });
        
        // Listen for service worker messages
        navigator.serviceWorker.addEventListener('message', (event) => {
          if (event.data.type === 'SYNC_SUCCESS') {
            console.log('Background sync successful:', event.data.message);
          } else if (event.data.type === 'SYNC_FAILED') {
            console.error('Background sync failed:', event.data.message);
          }
        });
      }
      
      // Install prompt for PWA
      let deferredPrompt;
      window.addEventListener('beforeinstallprompt', (e) => {
        // Prevent Chrome 67 and earlier from automatically showing the prompt
        e.preventDefault();
        // Stash the event so it can be triggered later
        deferredPrompt = e;
        
        // Show install button (you can add UI for this)
        console.log('PWA install prompt available');
        
        // Optionally show a custom install button
        showInstallButton();
      });
      
      function showInstallButton() {
        // Add install button to UI if desired
        const installBtn = document.createElement('button');
        installBtn.textContent = '📱 Install App';
        installBtn.className = 'install-btn';
        installBtn.style.cssText = `
          position: fixed;
          bottom: 20px;
          right: 20px;
          background: #667eea;
          color: white;
          border: none;
          padding: 12px 20px;
          border-radius: 25px;
          font-weight: 600;
          cursor: pointer;
          box-shadow: 0 4px 12px rgba(0,0,0,0.15);
          z-index: 1000;
          transition: all 0.3s ease;
        `;
        
        installBtn.addEventListener('click', async () => {
          if (deferredPrompt) {
            deferredPrompt.prompt();
            const { outcome } = await deferredPrompt.userChoice;
            console.log(`User response to install prompt: ${outcome}`);
            deferredPrompt = null;
            installBtn.remove();
          }
        });
        
        installBtn.addEventListener('mouseenter', () => {
          installBtn.style.transform = 'translateY(-2px)';
          installBtn.style.boxShadow = '0 6px 20px rgba(0,0,0,0.2)';
        });
        
        installBtn.addEventListener('mouseleave', () => {
          installBtn.style.transform = 'translateY(0)';
          installBtn.style.boxShadow = '0 4px 12px rgba(0,0,0,0.15)';
        });
        
        document.body.appendChild(installBtn);
        
        // Auto-hide after 10 seconds
        setTimeout(() => {
          if (installBtn.parentNode) {
            installBtn.style.opacity = '0';
            setTimeout(() => installBtn.remove(), 300);
          }
        }, 10000);
      }
    </script>
  </body>
</html>
