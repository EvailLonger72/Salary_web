<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes, viewport-fit=cover">
    <title>Navigation Error Debug - iOS/Android</title>
    
    <!-- Mobile optimizations -->
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="theme-color" content="#667eea">
    <meta name="format-detection" content="telephone=no">
    
    <!-- Include all styles -->
    <link rel="stylesheet" href="assets/css/main.css">
    <link rel="stylesheet" href="assets/css/mobile-navigation-fix.css">
    
    <style>
        body { font-family: Arial, sans-serif; margin: 0; padding: 10px; background: #f5f5f5; }
        .debug-container { max-width: 100%; margin: 0 auto; }
        .debug-section { background: white; margin: 10px 0; padding: 15px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .status { padding: 8px 12px; margin: 5px 0; border-radius: 5px; font-size: 0.9rem; }
        .success { background: #d4edda; color: #155724; border-left: 4px solid #28a745; }
        .error { background: #f8d7da; color: #721c24; border-left: 4px solid #dc3545; }
        .info { background: #d1ecf1; color: #0c5460; border-left: 4px solid #17a2b8; }
        .warning { background: #fff3cd; color: #856404; border-left: 4px solid #ffc107; }
        .test-btn { background: #667eea; color: white; border: none; padding: 12px 20px; border-radius: 8px; margin: 5px; cursor: pointer; font-size: 1rem; touch-action: manipulation; }
        .emergency-btn { background: #dc3545 !important; }
        .nav-test { background: #667eea; color: white; padding: 15px; margin: 8px 0; border-radius: 8px; cursor: pointer; text-align: center; font-weight: bold; touch-action: manipulation; }
        .nav-test:active { background: #5a6fd8; transform: scale(0.98); }
        .log { background: #f8f9fa; padding: 10px; margin: 10px 0; max-height: 200px; overflow-y: auto; font-family: 'Courier New', monospace; font-size: 0.85rem; border: 1px solid #ddd; border-radius: 5px; }
        .clear-btn { background: #6c757d; color: white; border: none; padding: 8px 15px; border-radius: 5px; font-size: 0.85rem; }
        h1 { color: #333; text-align: center; margin-bottom: 20px; }
        h3 { color: #667eea; margin-bottom: 10px; }
        .device-info { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        @media (max-width: 480px) {
            .device-info { grid-template-columns: 1fr; }
            .test-btn { width: 100%; margin: 5px 0; }
        }
    </style>
</head>
<body>
    <div class="debug-container">
        <h1>🚨 Navigation Error Debug</h1>
        
        <div class="debug-section">
            <h3>📱 Device Information:</h3>
            <div id="deviceInfo" class="device-info"></div>
        </div>
        
        <div class="debug-section">
            <h3>⚡ Quick Tests:</h3>
            <button class="test-btn" onclick="runFullDiagnostic()">🔍 Full Diagnostic</button>
            <button class="test-btn" onclick="testNavigationElements()">🧭 Test Navigation Elements</button>
            <button class="test-btn" onclick="checkEventListeners()">👂 Check Event Listeners</button>
            <button class="test-btn emergency-btn" onclick="emergencyFixNavigation()">🚨 Emergency Fix</button>
        </div>
        
        <div class="debug-section">
            <h3>🧪 Navigation Tests:</h3>
            <div class="nav-test" onclick="testDirectNavigation('Dashboard', '../index.html#dashboard')">
                📊 Test Dashboard Navigation
            </div>
            <div class="nav-test" onclick="testDirectNavigation('Calculator', '../index.html#calculator')">
                💰 Test Calculator Navigation
            </div>
            <div class="nav-test" onclick="testDirectNavigation('Tax Calculator', 'pages/tax-calculator.html')">
                🧮 Test Tax Calculator Navigation
            </div>
            <div class="nav-test" onclick="testDirectNavigation('Calendar', 'pages/calendar.html')">
                🗓️ Test Calendar Navigation
            </div>
        </div>
        
        <div class="debug-section">
            <h3>📊 Navigation State Monitor:</h3>
            <div id="navigationState"></div>
            <button class="test-btn" onclick="monitorNavigationState()">🔄 Start Monitoring</button>
            <button class="clear-btn" onclick="stopMonitoring()">⏹️ Stop</button>
        </div>
        
        <div class="debug-section">
            <h3>📝 Debug Log:</h3>
            <button class="clear-btn" onclick="clearLog()">🗑️ Clear Log</button>
            <div id="debugLog" class="log"></div>
        </div>
        
        <div class="debug-section">
            <h3>🆘 Manual Fixes:</h3>
            <button class="test-btn" onclick="resetAllStyles()">🧹 Reset All Styles</button>
            <button class="test-btn" onclick="removeAllEventListeners()">🗑️ Remove Event Listeners</button>
            <button class="test-btn" onclick="forceReload()">🔄 Force Reload</button>
        </div>
    </div>
    
    <!-- Include navigation fix -->
    <script src="assets/js/modules/ios-android-navigation-fix.js"></script>
    
    <script>
        let logEntries = [];
        let monitoringInterval = null;
        
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const entry = { timestamp, message, type };
            logEntries.push(entry);
            
            const logDiv = document.getElementById('debugLog');
            const div = document.createElement('div');
            div.className = 'status ' + type;
            div.innerHTML = `[${timestamp}] ${message}`;
            logDiv.appendChild(div);
            logDiv.scrollTop = logDiv.scrollHeight;
            
            // Keep only last 50 entries
            if (logEntries.length > 50) {
                logEntries.shift();
                logDiv.removeChild(logDiv.firstChild);
            }
        }
        
        function clearLog() {
            document.getElementById('debugLog').innerHTML = '';
            logEntries = [];
        }
        
        function detectDevice() {
            const info = document.getElementById('deviceInfo');
            
            const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) || 
                         (navigator.platform === 'MacIntel' && navigator.maxTouchPoints > 1);
            const isAndroid = /Android/.test(navigator.userAgent);
            const isMobile = /Mobi|Android/i.test(navigator.userAgent);
            const isTouch = 'ontouchstart' in window || navigator.maxTouchPoints > 0;
            
            info.innerHTML = `
                <div class="status ${isIOS ? 'success' : 'info'}">iOS: ${isIOS ? 'YES' : 'NO'}</div>
                <div class="status ${isAndroid ? 'success' : 'info'}">Android: ${isAndroid ? 'YES' : 'NO'}</div>
                <div class="status ${isMobile ? 'success' : 'info'}">Mobile: ${isMobile ? 'YES' : 'NO'}</div>
                <div class="status ${isTouch ? 'success' : 'info'}">Touch: ${isTouch ? 'YES' : 'NO'}</div>
                <div class="status info">Screen: ${screen.width}×${screen.height}</div>
                <div class="status info">Viewport: ${window.innerWidth}×${window.innerHeight}</div>
                <div class="status info">UA: ${navigator.userAgent.substring(0, 50)}...</div>
            `;
        }
        
        function runFullDiagnostic() {
            log('🔍 Starting full diagnostic...', 'info');
            
            // Check if our fix module loaded
            if (typeof window.iOSAndroidNavFixer !== 'undefined') {
                log('✅ iOS/Android Navigation Fixer loaded', 'success');
            } else {
                log('❌ iOS/Android Navigation Fixer NOT loaded', 'error');
            }
            
            // Check body styles
            const bodyStyle = window.getComputedStyle(document.body);
            log(`Body overflow: ${bodyStyle.overflow}`, bodyStyle.overflow === 'hidden' ? 'warning' : 'success');
            log(`Touch action: ${bodyStyle.touchAction}`, bodyStyle.touchAction === 'none' ? 'warning' : 'success');
            log(`Pointer events: ${bodyStyle.pointerEvents}`, bodyStyle.pointerEvents === 'none' ? 'error' : 'success');
            
            // Check for navigation elements
            const navItems = document.querySelectorAll('.nav-item');
            log(`Found ${navItems.length} navigation items`, navItems.length > 0 ? 'info' : 'warning');
            
            // Check for onclick handlers
            const onclickItems = document.querySelectorAll('[onclick]');
            log(`Found ${onclickItems.length} elements with onclick`, 'info');
            
            // Check console errors
            window.addEventListener('error', function(e) {
                log(`JS Error: ${e.message} at ${e.filename}:${e.lineno}`, 'error');
            });
            
            log('✅ Full diagnostic completed', 'success');
        }
        
        function testNavigationElements() {
            log('🧭 Testing navigation elements...', 'info');
            
            const testElements = [
                { selector: '.sidebar', name: 'Sidebar' },
                { selector: '.mobile-overlay', name: 'Mobile Overlay' },
                { selector: '.mobile-menu-toggle', name: 'Mobile Toggle' },
                { selector: '.nav-item', name: 'Navigation Items' }
            ];
            
            testElements.forEach(({ selector, name }) => {
                const elements = document.querySelectorAll(selector);
                if (elements.length > 0) {
                    log(`✅ ${name}: Found ${elements.length}`, 'success');
                } else {
                    log(`❌ ${name}: Not found`, 'error');
                }
            });
        }
        
        function checkEventListeners() {
            log('👂 Checking event listeners...', 'info');
            
            // Check if we can detect event listeners (limited by browser security)
            const navItems = document.querySelectorAll('.nav-item');
            let listenersFound = 0;
            
            navItems.forEach((item, index) => {
                // Check for onclick attribute
                if (item.hasAttribute('onclick')) {
                    log(`Nav item ${index + 1}: Has onclick attribute`, 'info');
                    listenersFound++;
                }
                
                // Check for our custom event listeners (approximate)
                if (item._hasCustomListeners) {
                    log(`Nav item ${index + 1}: Has custom listeners`, 'success');
                }
            });
            
            log(`Total listeners detected: ${listenersFound}`, 'info');
        }
        
        function testDirectNavigation(name, url) {
            log(`🚀 Testing direct navigation to ${name}...`, 'info');
            
            try {
                // Test URL validity
                const testUrl = new URL(url, window.location.href);
                log(`✅ ${name} URL is valid: ${testUrl.href}`, 'success');
                
                // Attempt navigation
                setTimeout(() => {
                    try {
                        window.location.href = url;
                        log(`🔗 Navigation to ${name} initiated`, 'success');
                    } catch (error) {
                        log(`❌ Navigation to ${name} failed: ${error.message}`, 'error');
                    }
                }, 500);
                
            } catch (error) {
                log(`❌ Invalid URL for ${name}: ${error.message}`, 'error');
            }
        }
        
        function monitorNavigationState() {
            if (monitoringInterval) return;
            
            log('🔄 Starting navigation state monitoring...', 'info');
            
            monitoringInterval = setInterval(() => {
                const stateDiv = document.getElementById('navigationState');
                const bodyStyle = window.getComputedStyle(document.body);
                
                const state = {
                    overflow: bodyStyle.overflow,
                    touchAction: bodyStyle.touchAction,
                    pointerEvents: bodyStyle.pointerEvents,
                    position: bodyStyle.position,
                    timestamp: new Date().toLocaleTimeString()
                };
                
                stateDiv.innerHTML = `
                    <div class="status ${state.overflow === 'hidden' ? 'warning' : 'success'}">
                        Overflow: ${state.overflow}
                    </div>
                    <div class="status ${state.touchAction === 'none' ? 'warning' : 'success'}">
                        Touch Action: ${state.touchAction}
                    </div>
                    <div class="status ${state.pointerEvents === 'none' ? 'error' : 'success'}">
                        Pointer Events: ${state.pointerEvents}
                    </div>
                    <div class="status info">Last Updated: ${state.timestamp}</div>
                `;
                
                // Auto-fix if navigation is blocked
                if (state.pointerEvents === 'none' && state.overflow === 'hidden') {
                    log('🚨 Auto-fixing blocked navigation...', 'warning');
                    resetAllStyles();
                }
                
            }, 1000);
        }
        
        function stopMonitoring() {
            if (monitoringInterval) {
                clearInterval(monitoringInterval);
                monitoringInterval = null;
                log('⏹️ Navigation monitoring stopped', 'info');
            }
        }
        
        function resetAllStyles() {
            log('🧹 Resetting all potentially problematic styles...', 'warning');
            
            // Reset body
            document.body.style.cssText = '';
            document.body.className = '';
            
            // Reset html
            document.documentElement.style.cssText = '';
            
            // Reset all elements with problematic styles
            const elements = document.querySelectorAll('*');
            elements.forEach(el => {
                if (el.style.pointerEvents === 'none') el.style.pointerEvents = '';
                if (el.style.touchAction === 'none') el.style.touchAction = '';
                if (el.style.overflow === 'hidden') el.style.overflow = '';
            });
            
            log('✅ All styles reset', 'success');
        }
        
        function removeAllEventListeners() {
            log('🗑️ Attempting to remove conflicting event listeners...', 'warning');
            
            // Clone and replace elements to remove all event listeners
            const navItems = document.querySelectorAll('.nav-item');
            navItems.forEach(item => {
                const clone = item.cloneNode(true);
                item.parentNode.replaceChild(clone, item);
            });
            
            log('✅ Navigation elements reset', 'success');
        }
        
        function forceReload() {
            log('🔄 Force reloading page...', 'info');
            setTimeout(() => {
                window.location.reload(true);
            }, 500);
        }
        
        // Initialize on load
        window.addEventListener('load', function() {
            detectDevice();
            log('🚀 Navigation error debug page loaded', 'success');
            
            // Auto-run diagnostic after short delay
            setTimeout(() => {
                runFullDiagnostic();
                monitorNavigationState();
            }, 1000);
        });
        
        // Catch all errors
        window.addEventListener('error', function(e) {
            log(`💥 Global Error: ${e.message} at ${e.filename}:${e.lineno}`, 'error');
        });
        
        // Monitor page visibility
        document.addEventListener('visibilitychange', function() {
            if (!document.hidden) {
                log('👁️ Page became visible - checking navigation state...', 'info');
                setTimeout(runFullDiagnostic, 500);
            }
        });
        
        // Add touch feedback to test buttons
        document.querySelectorAll('.test-btn, .nav-test').forEach(btn => {
            btn.addEventListener('touchstart', function() {
                this.style.opacity = '0.7';
            }, { passive: true });
            
            btn.addEventListener('touchend', function() {
                this.style.opacity = '';
            }, { passive: true });
        });
    </script>
</body>
</html>