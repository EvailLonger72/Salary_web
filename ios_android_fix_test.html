<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes, viewport-fit=cover">
    <title>iOS/Android Navigation & Calendar Test</title>
    
    <!-- Mobile optimizations -->
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="theme-color" content="#667eea">
    <meta name="format-detection" content="telephone=no">
    
    <!-- Include all styles -->
    <link rel="stylesheet" href="assets/css/main.css">
    <link rel="stylesheet" href="assets/css/calendar.css">
    <link rel="stylesheet" href="assets/css/mobile-navigation-fix.css">
    <link rel="stylesheet" href="assets/css/calendar-ios-fix.css">
    
    <style>
        .test-container { max-width: 800px; margin: 0 auto; padding: 20px; }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 10px; }
        .status { padding: 10px; margin: 5px 0; border-radius: 5px; }
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
        .info { background: #d1ecf1; color: #0c5460; }
        .warning { background: #fff3cd; color: #856404; }
        .test-btn { background: #667eea; color: white; border: none; padding: 10px 15px; border-radius: 5px; margin: 5px; cursor: pointer; }
        .nav-test-item { background: #f8f9fa; padding: 10px; margin: 5px; border-radius: 5px; cursor: pointer; border: 1px solid #ddd; }
        .mini-calendar { display: grid; grid-template-columns: repeat(7, 1fr); gap: 2px; margin: 10px 0; }
        .mini-day { aspect-ratio: 1; background: #f8f9fa; border: 1px solid #ddd; display: flex; align-items: center; justify-content: center; font-size: 0.8rem; }
        .mini-day.today { background: #667eea; color: white; font-weight: bold; }
        .log { background: #f5f5f5; padding: 10px; margin: 10px 0; max-height: 300px; overflow-y: auto; font-family: monospace; font-size: 0.9rem; }
    </style>
</head>
<body>
    <div class="test-container">
        <h1>📱 iOS/Android Fix Test</h1>
        
        <div class="test-section">
            <h3>🔧 Issues Being Fixed:</h3>
            <div class="info">
                <strong>Navigation Issue:</strong> Can't navigate to other pages after visiting tax calculator/calendar on iOS/Android
            </div>
            <div class="info">
                <strong>Calendar Issue:</strong> Calendar needs to look good on iOS screens
            </div>
        </div>
        
        <div class="test-section">
            <h3>📱 Device Detection:</h3>
            <div id="deviceInfo"></div>
        </div>
        
        <div class="test-section">
            <h3>🧪 Navigation Recovery Tests:</h3>
            <button class="test-btn" onclick="testNavigationState()">Check Navigation State</button>
            <button class="test-btn" onclick="simulateNavigationBlock()">Simulate Block</button>
            <button class="test-btn" onclick="testEmergencyReset()">Emergency Reset</button>
            <button class="test-btn" onclick="testPageReturn()">Simulate Page Return</button>
        </div>
        
        <div class="test-section">
            <h3>🔗 Test External Navigation:</h3>
            <div class="nav-test-item" onclick="testNavigation('tax-calculator', 'pages/tax-calculator.html')">
                🧮 Navigate to Tax Calculator
            </div>
            <div class="nav-test-item" onclick="testNavigation('calendar', 'pages/calendar.html')">
                🗓️ Navigate to Calendar
            </div>
            <div class="nav-test-item" onclick="testNavigation('main', 'index.html')">
                📊 Navigate to Main App
            </div>
        </div>
        
        <div class="test-section">
            <h3>🗓️ iOS Calendar Preview:</h3>
            <div style="background: rgba(255,255,255,0.95); padding: 20px; border-radius: 15px; backdrop-filter: blur(10px);">
                <h4 style="text-align: center; color: #667eea; margin-bottom: 20px;">November 2024</h4>
                <div class="mini-calendar">
                    <div style="font-weight: bold; text-align: center; padding: 5px;">Sun</div>
                    <div style="font-weight: bold; text-align: center; padding: 5px;">Mon</div>
                    <div style="font-weight: bold; text-align: center; padding: 5px;">Tue</div>
                    <div style="font-weight: bold; text-align: center; padding: 5px;">Wed</div>
                    <div style="font-weight: bold; text-align: center; padding: 5px;">Thu</div>
                    <div style="font-weight: bold; text-align: center; padding: 5px;">Fri</div>
                    <div style="font-weight: bold; text-align: center; padding: 5px;">Sat</div>
                    <div class="mini-day">1</div>
                    <div class="mini-day">2</div>
                    <div class="mini-day">3</div>
                    <div class="mini-day">4</div>
                    <div class="mini-day">5</div>
                    <div class="mini-day">6</div>
                    <div class="mini-day">7</div>
                    <div class="mini-day">8</div>
                    <div class="mini-day">9</div>
                    <div class="mini-day">10</div>
                    <div class="mini-day">11</div>
                    <div class="mini-day">12</div>
                    <div class="mini-day">13</div>
                    <div class="mini-day">14</div>
                    <div class="mini-day">15</div>
                    <div class="mini-day">16</div>
                    <div class="mini-day">17</div>
                    <div class="mini-day">18</div>
                    <div class="mini-day">19</div>
                    <div class="mini-day">20</div>
                    <div class="mini-day">21</div>
                    <div class="mini-day">22</div>
                    <div class="mini-day">23</div>
                    <div class="mini-day">24</div>
                    <div class="mini-day today">25</div>
                    <div class="mini-day" style="background: rgba(255,126,234,0.2);">26</div>
                    <div class="mini-day">27</div>
                    <div class="mini-day">28</div>
                    <div class="mini-day">29</div>
                    <div class="mini-day">30</div>
                </div>
                <div style="text-align: center; margin-top: 15px;">
                    <small style="color: #666;">✨ iOS-optimized calendar design with safe areas and touch targets</small>
                </div>
            </div>
        </div>
        
        <div class="test-section">
            <h3>📝 Test Log:</h3>
            <div id="testLog" class="log"></div>
        </div>
        
        <div class="test-section">
            <h3>🆘 Emergency Tools:</h3>
            <button class="test-btn" onclick="fixMobileNavigation()" style="background: #dc3545;">Emergency Fix Navigation</button>
            <button class="test-btn" onclick="clearAllStyles()" style="background: #ffc107; color: #000;">Clear All Styles</button>
            <button class="test-btn" onclick="reloadPage()" style="background: #28a745;">Reload Page</button>
        </div>
    </div>
    
    <!-- Include mobile navigation -->
    <script src="assets/js/modules/mobile-navigation.js"></script>
    
    <script>
        let testResults = [];
        
        function log(message, type = 'info') {
            const logDiv = document.getElementById('testLog');
            const div = document.createElement('div');
            div.className = 'status ' + type;
            div.innerHTML = `${new Date().toLocaleTimeString()}: ${message}`;
            logDiv.appendChild(div);
            logDiv.scrollTop = logDiv.scrollHeight;
        }
        
        function detectDevice() {
            const deviceInfo = document.getElementById('deviceInfo');
            
            const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) || 
                         (navigator.platform === 'MacIntel' && navigator.maxTouchPoints > 1);
            const isAndroid = /Android/.test(navigator.userAgent);
            const isMobile = /Mobi|Android/i.test(navigator.userAgent);
            const isTouch = 'ontouchstart' in window || navigator.maxTouchPoints > 0;
            const hasSafeArea = CSS.supports('padding: env(safe-area-inset-top)');
            
            let info = '';
            info += `<div class="status ${isIOS ? 'success' : 'info'}">🍎 iOS Device: ${isIOS ? 'YES' : 'NO'}</div>`;
            info += `<div class="status ${isAndroid ? 'success' : 'info'}">🤖 Android Device: ${isAndroid ? 'YES' : 'NO'}</div>`;
            info += `<div class="status ${isMobile ? 'success' : 'info'}">📱 Mobile Device: ${isMobile ? 'YES' : 'NO'}</div>`;
            info += `<div class="status ${isTouch ? 'success' : 'info'}">👆 Touch Support: ${isTouch ? 'YES' : 'NO'}</div>`;
            info += `<div class="status ${hasSafeArea ? 'success' : 'info'}">🛡️ Safe Area Support: ${hasSafeArea ? 'YES' : 'NO'}</div>`;
            info += `<div class="status info">📐 Screen: ${screen.width}×${screen.height}</div>`;
            info += `<div class="status info">🖼️ Viewport: ${window.innerWidth}×${window.innerHeight}</div>`;
            
            deviceInfo.innerHTML = info;
        }
        
        function testNavigationState() {
            log('🔍 Testing navigation state...', 'info');
            
            // Check body styles
            const bodyStyles = window.getComputedStyle(document.body);
            const overflow = bodyStyles.overflow;
            const touchAction = bodyStyles.touchAction;
            const pointerEvents = bodyStyles.pointerEvents;
            
            log(`Body overflow: ${overflow}`, overflow === 'hidden' ? 'warning' : 'success');
            log(`Touch action: ${touchAction}`, touchAction === 'none' ? 'warning' : 'success');
            log(`Pointer events: ${pointerEvents}`, pointerEvents === 'none' ? 'warning' : 'success');
            
            // Check mobile navigation
            if (typeof window.MobileNavigation !== 'undefined') {
                log('✅ MobileNavigation available', 'success');
                log(`Initialized: ${window.MobileNavigation.isInitialized}`, 'info');
            } else {
                log('❌ MobileNavigation not found', 'error');
            }
            
            // Check navigation elements
            const sidebar = document.querySelector('.sidebar');
            const overlay = document.querySelector('.mobile-overlay');
            const toggle = document.querySelector('.mobile-menu-toggle');
            
            log(`Sidebar: ${sidebar ? 'Found' : 'Missing'}`, sidebar ? 'success' : 'error');
            log(`Overlay: ${overlay ? 'Found' : 'Missing'}`, overlay ? 'success' : 'error');
            log(`Toggle: ${toggle ? 'Found' : 'Missing'}`, toggle ? 'success' : 'error');
        }
        
        function simulateNavigationBlock() {
            log('🚫 Simulating navigation block...', 'warning');
            
            // Simulate the blocking condition
            document.body.style.overflow = 'hidden';
            document.body.style.touchAction = 'none';
            document.body.style.pointerEvents = 'none';
            
            log('Navigation blocked - touch events disabled', 'error');
            
            setTimeout(() => {
                log('Auto-recovery in 3 seconds...', 'info');
                testEmergencyReset();
            }, 3000);
        }
        
        function testEmergencyReset() {
            log('🚨 Testing emergency reset...', 'info');
            
            if (typeof window.fixMobileNavigation === 'function') {
                window.fixMobileNavigation();
                log('✅ Emergency reset function called', 'success');
            } else {
                // Manual reset
                document.body.style.overflow = '';
                document.body.style.touchAction = '';
                document.body.style.pointerEvents = '';
                document.body.classList.remove('mobile-menu-open');
                log('✅ Manual reset applied', 'success');
            }
            
            setTimeout(() => {
                testNavigationState();
            }, 500);
        }
        
        function testPageReturn() {
            log('🔄 Simulating page return...', 'info');
            
            // Simulate visibility change (like returning from external page)
            document.dispatchEvent(new Event('visibilitychange'));
            
            // Simulate window focus
            window.dispatchEvent(new Event('focus'));
            
            log('✅ Page return events triggered', 'success');
        }
        
        function testNavigation(pageName, url) {
            log(`🔗 Testing navigation to ${pageName}...`, 'info');
            
            try {
                const testUrl = new URL(url, window.location.href);
                log(`✅ ${pageName} URL valid: ${testUrl.href}`, 'success');
                
                // Open in new tab for testing
                const newWindow = window.open(url, '_blank');
                if (newWindow) {
                    log(`✅ ${pageName} opened in new tab`, 'success');
                    
                    // Simulate returning after navigation
                    setTimeout(() => {
                        log(`🔄 Simulating return from ${pageName}...`, 'info');
                        testPageReturn();
                    }, 2000);
                } else {
                    log(`❌ Failed to open ${pageName} - popup blocked?`, 'error');
                }
                
            } catch (error) {
                log(`❌ Navigation error for ${pageName}: ${error.message}`, 'error');
            }
        }
        
        function clearAllStyles() {
            log('🧹 Clearing all problematic styles...', 'warning');
            
            document.body.style.cssText = '';
            document.documentElement.style.cssText = '';
            
            log('✅ All styles cleared', 'success');
        }
        
        function reloadPage() {
            log('🔄 Reloading page...', 'info');
            window.location.reload();
        }
        
        // Auto-run tests on load
        window.addEventListener('load', function() {
            detectDevice();
            log('🚀 iOS/Android fix test loaded', 'success');
            
            setTimeout(() => {
                testNavigationState();
            }, 1000);
        });
        
        // Monitor for issues
        window.addEventListener('error', function(e) {
            log(`❌ JavaScript Error: ${e.message}`, 'error');
        });
        
        // Monitor visibility changes
        document.addEventListener('visibilitychange', function() {
            if (!document.hidden) {
                log('👁️ Page became visible - checking navigation...', 'info');
                setTimeout(testNavigationState, 500);
            }
        });
        
        // Monitor window focus
        window.addEventListener('focus', function() {
            log('🎯 Window focused', 'info');
        });
    </script>
</body>
</html>